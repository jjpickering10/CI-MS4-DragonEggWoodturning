{% extends 'base.html' %}
{% load static %}

{% block page_header %}
  All wood used is sustainable and ethically sourced
{% endblock %}

{% block page_header_paragraph %}
  <span>{{ profile.user }}</span>
{% endblock %}

{% block content %}

<div class="profile-container">
    <div class="profile-nav">

        <h2>Menu</h2>
        <ul>
          <li class="profile-links active" data-link='home'><i class="fas fa-user"></i>Profile Home</li>
          <li class="profile-links" data-link='account'><i class="fas fa-user"></i>Account Info</li>
          <li class="profile-links" data-link='orders'><i class="fas fa-credit-card"></i>Orders</li>
          <li class="profile-links" data-link='reviews'><i class="fas fa-star"></i>Reviews</li>
          {% if request.user.is_superuser %}
          <li class="profile-links" data-link='newsletter'><i class="fas fa-mail-bulk"></i>Newsletter</li>
          <li class="profile-links" data-link='discount'><i class="fas fa-mail-bulk"></i>Discounts</li>
          <li class="profile-links" data-link='products'><i class="fas fa-mail-bulk"></i>Products</li>
          {% endif %}
        </ul>

    </div>
    <div class="profile-section">
      <div data-link='home' class="profile-home-container profile-segment">
        <h2>Hello, <span>{{ profile.user }}</span></h2>
        {% if profile.user.date_joined %}
        <p><i class="fas fa-calendar-check"></i> Member since {{ profile.user.date_joined }}</p>
        {% endif %}
        {% if profile.user.last_login %}
        <p><i class="far fa-clock"></i> Last login {{ profile.user.last_login }}</p>
        {% endif %}
      </div>
      <div data-link='account' class="profile-account-info-container profile-segment hide">
        <form action="{% url 'profile' %}" method="POST" id="profile-form">
          {% csrf_token %}
          <!-- Used help to get for attribute after Django removed it after adding fieldsets in -  https://www.skillsugar.com/how-to-get-form-input-id-label-name-in-django-template -->
          <fieldset>
            <legend>Details</legend>
            <label for="{{ form.full_name.id_for_label }}">{{ form.full_name.label }}</label>
            {{ form.full_name }}
            <label for="{{ form.email.id_for_label }}">{{ form.email.label }}</label>
            {{ form.email }}
          </fieldset>
          <fieldset>
            <legend>Delivery</legend>
            <label for="{{ form.phone_number.id_for_label }}">{{ form.phone_number.label }}</label>
            {{ form.phone_number }}
            <label for="{{ form.street_address1.id_for_label }}">{{ form.street_address1.label }}</label>
            {{ form.street_address1 }}
            <label for="{{ form.street_address2.id_for_label }}">{{ form.street_address2.label }}</label>
            {{ form.street_address2 }}
            <label for="{{ form.town_or_city.id_for_label }}">{{ form.town_or_city.label }}</label>
            {{ form.town_or_city }}
            <label for="{{ form.postcode.id_for_label }}">{{ form.postcode.label }}</label>
            {{ form.postcode }}
            <label for="{{ form.county.id_for_label }}">{{ form.county.label }}</label>
            {{ form.county }}
            <label for="{{ form.country.id_for_label }}">{{ form.country.label }}</label>
            {{ form.country }}
          </fieldset>

          <div class="checkout-pay-section">
            <button class="global-button" id="submit-button" type="submit">
              Update Profile
            </button>
          </div>
        </form>
      </div>
      <div data-link='orders' class="profile-orders-container profile-segment hide">
        <div class="bag-container">
          <div class="bag-table">
              <table>
                <thead>
                  <tr>
                    <th>Order No.</th>
                    <th>Date</th>
                    <th>Items</th>
                    <th>Total</th>
                  </tr>
                </thead>
          
                {% for order in orders %}
                <tbody>
                  <tr>
                    <td class="product-td"><a href="{% url 'checkout_success' order.order_number %}">{{ order.order_number|truncatechars:5 }}</a></td>
                    <td>{{ order.date }}</td>
                    <td>
                      {% for item in order.lineitems.all %}
                      <p>{{ item.product.name}} x {{ item.quantity }}</p>
                      {% endfor %}
                    </td>
                    <td>Â£{{ order.grand_total }}</td>
                  </tr>
                </tbody>
                {% endfor %}
                
              </table>
          </div>
        </div>
      </div>
      <div data-link='reviews' class="profile-review-container profile-segment hide">
          {% for review in reviews %}
            <div class="review-content">
              <h3>{{ review.product.name }}</h3>
            {% if review.rating == 1 %}
            <!-- 1 star rating -->
              <div class="review-rating">
                <i class="fas fa-star"></i>
                <i class="far fa-star"></i>
                <i class="far fa-star"></i>
                <i class="far fa-star"></i>
                <i class="far fa-star"></i>
              </div>
              {% endif %}
              {% if review.rating == 2 %}
              <!-- 2 star rating -->
              <div class="review-rating">
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="far fa-star"></i>
                <i class="far fa-star"></i>
                <i class="far fa-star"></i>
              </div>
              {% endif %}
              {% if review.rating == 3 %}
              <!-- 3 star rating -->
              <div class="review-rating">
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="far fa-star"></i>
                <i class="far fa-star"></i>
              </div>
              {% endif %}
              {% if review.rating == 4 %}
              <!-- 4 star rating -->
              <div class="review-rating">
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="far fa-star"></i>
              </div>
              {% endif %}
              {% if review.rating == 5 %}
              <!-- 5 star rating -->
              <div class="review-rating">
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
              </div>
              {% endif %}
              <p><i class="fas fa-quote-left"></i><span>{{ review.body }}</span><i class="fas fa-quote-right"></i></p>
              <p class="review-date">{{ review.date }}</p>
            </div>
          {% endfor %}
      </div>
      {% if request.user.is_superuser %}
      <div data-link='newsletter' class="profile-admin-newsletter-container profile-segment hide">
        <form action="{% url 'send_newsletter' %}" method="POST">
          {% csrf_token %}
          {{ newsletter_form }}
          <button class="global-button" type="submit">Send newsletter</button>
        </form>
      </div>
      <div data-link='discount' class="profile-admin-discount-container profile-segment hide">
        {% for category in categories %}
          <div class="category-content">
            <h5>{{ category.friendly_name }}
              {% if category.on_sale_amount %}
              <span>*** ON SALE - {{ category.on_sale_amount }}% ***</span>
              {% endif %}
            </h5>
            <form action="{% url 'category_discount' category.id %}" method="POST">
              {% csrf_token %}
              {{ discount_form }}
              <button class="global-button" type="submit">Add discounts</button>
            </form>
          </div>
        {% endfor %}
      </div>
      <div data-link='products' class="profile-admin-discount-container profile-segment hide">
        <h2>Add New Product</h2>
        <form action="{% url 'add_product' %}" method="POST" enctype="multipart/form-data">
          {% csrf_token %}
          {{ product_form }}
          {{ image_form }}
          <button type="submit">Add Product</button>
        </form>
        <hr>
        <h2>Current Products</h2>
        {% for category in categories %}
          <h3>{{ category.friendly_name }}({{ category.product_set.all|length }})</h3>
        <table>
        <thead>
          <tr>
            <th>Product</th>
          </tr>
        </thead>
  
        {% for product in category.product_set.all %}
        <tbody>
          <tr>
            <td><a href="{% url 'product_detail' product.id %}">{{ product.name }}</a></td>
            <td><a href="">Edit</a></td>
            <td><a href="{% url 'delete_product' product.id %}">Delete</a></td>
          </tr>
        </tbody>
        {% endfor %}
        
        </table>
        {% endfor %}
      </div>
      {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
 const links = document.querySelectorAll('.profile-links')
 const sections = document.querySelectorAll('.profile-segment')
 let dataLink

 // Display check for current section

 function checkSections(dataLink) {
   sections.forEach(section => {
    section.classList.add('hide')
    if (dataLink === section.dataset.link) {
      section.classList.remove('hide')
    }
   })
 }

 links.forEach(link => {
  link.addEventListener('click', ()=> {
    links.forEach(oldlink => {
      oldlink.classList.remove('active')
    })
    link.classList.add('active')
    dataLink = link.dataset.link
    console.log(dataLink);
    checkSections(dataLink)
  })
 })


</script>
{% endblock %}